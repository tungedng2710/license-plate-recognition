<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User</title>
  <link rel="stylesheet" href="style.css?v=13">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="layout">
    <div class="sidebar glass">
      <a href="index.html#/home" id="logo-link" class="flex items-center my-4">
        <img src="static/tonai_logo.png" alt="TonAI Logo" class="h-8 w-8 mr-2">
        <h1 class="text-2xl font-bold">TonAI</h1>
      </a>
      <a href="index.html#/home" id="home-link"><i class="fas fa-home"></i><span class="link-text">Home</span></a>
      <a href="index.html#/projects" id="projects-link"><i class="fas fa-project-diagram"></i><span class="link-text">Projects</span></a>
      <a href="https://github.com/tungedng2710/license-plate-recognition" target="_blank"><i class="fab fa-github"></i><span class="link-text">GitHub</span></a>
      <a href="user.html" class="user-settings active"><img src="https://avatars.githubusercontent.com/u/48611435?v=4" alt="User Avatar" class="h-8 w-8 rounded-full mr-2"><span class="link-text">Edward</span></a>
    </div>
    <div class="main-content">
      <h1 class="text-4xl font-bold title">User</h1>

      <div class="cards-grid">
        <!-- API Key Card -->
        <div class="card">
          <div class="card-header">
            <div class="font-semibold">API Key</div>
            <div class="flex gap-2">
              <button id="toggle-key" class="rounded">Hide</button>
              <button id="copy-key" class="rounded">Copy</button>
            </div>
          </div>
          <div class="mono" id="api-key" style="user-select: all;">loading...</div>
          <div class="muted mt-2">Use this key to authenticate API requests.</div>
        </div>

        <!-- Plan Card -->
        <div class="card">
          <div class="card-header">
            <div class="font-semibold">Current Plan</div>
          </div>
          <div class="row">
            <div>
              <div class="text-lg font-semibold" id="current-plan">Free</div>
              <div class="muted">Basic features with fair usage limits.</div>
            </div>
            <div class="flex gap-2">
              <button id="upgrade-btn" class="rounded">Upgrade Plan</button>
            </div>
          </div>
        </div>

        <!-- User Information Card -->
        <div class="card" id="user-card">
          <div class="card-header">
            <div class="font-semibold">Account</div>
            <button id="logout-btn" class="rounded">Logout</button>
          </div>
          <div class="row">
            <div class="flex items-center gap-3">
              <img src="https://avatars.githubusercontent.com/u/48611435?v=4" alt="Avatar" class="h-10 w-10 rounded-full" />
              <div>
                <div><strong>Name:</strong> <span id="ui-name">User</span></div>
                <div class="muted"><strong>Email:</strong> <span id="ui-email">user@example.com</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Information Card -->
        <div class="card" id="sys-card">
          <div class="card-header">
            <div class="font-semibold">System Information</div>
            <button id="refresh-sys" class="rounded">Refresh</button>
          </div>
          <div id="sys-info" class="muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // simple random dummy API key stored in localStorage
      const KEY_NAME = 'dummyApiKey';
      let key = localStorage.getItem(KEY_NAME);
      if (!key) {
        const bytes = crypto.getRandomValues(new Uint8Array(24));
        key = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        key = 'tok_' + key;
        localStorage.setItem(KEY_NAME, key);
      }
      const keyEl = document.getElementById('api-key');
      const toggleBtn = document.getElementById('toggle-key');
      let masked = false;

      function mask(v){ return '•'.repeat(Math.max(8, v.length - 6)) + v.slice(-6); }
      function render(){ keyEl.textContent = masked ? mask(key) : key; toggleBtn.textContent = masked ? 'Show' : 'Hide'; }
      render();

      toggleBtn.addEventListener('click', () => { masked = !masked; render(); });
      document.getElementById('copy-key').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(key);
          alert('API key copied to clipboard');
        } catch (e) {
          alert('Copy failed');
        }
      });
      document.getElementById('upgrade-btn').addEventListener('click', () => {
        alert('Upgrade coming soon. You are on the Free plan.');
      });

      // Populate user info
      const storedName = localStorage.getItem('userName') || localStorage.getItem('user') || 'Edward';
      const storedEmail = localStorage.getItem('userEmail') || (storedName.toLowerCase() + '@example.com');
      document.getElementById('ui-name').textContent = storedName;
      document.getElementById('ui-email').textContent = storedEmail;

      // Fetch and render system info
      async function fetchSys() {
        const el = document.getElementById('sys-info');
        el.textContent = 'Loading...';
        try {
          const res = await fetch('/api/system_info');
          const data = await res.json();
          const os = data.os || {};
          const cpu = data.cpu || {};
          const ram = data.ram || {};
          const gpus = Array.isArray(data.gpus) ? data.gpus : [];

          const rows = [];
          rows.push(`<div><strong>OS:</strong> ${[os.system, os.release].filter(Boolean).join(' ')} (${os.machine || ''})</div>`);
          if (os.python) rows.push(`<div><strong>Python:</strong> ${os.python}</div>`);
          const cpuParts = [];
          if (cpu.model) cpuParts.push(cpu.model);
          if (cpu.cores_physical) cpuParts.push(`${cpu.cores_physical} physical cores`);
          if (cpu.cores_logical) cpuParts.push(`${cpu.cores_logical} logical`);
          if (typeof cpu.utilization_percent === 'number') cpuParts.push(`${cpu.utilization_percent}%`);
          if (cpuParts.length) rows.push(`<div><strong>CPU:</strong> ${cpuParts.join(' • ')}</div>`);
          const ramParts = [];
          if (ram.total_gb) ramParts.push(`Total ${ram.total_gb} GB`);
          if (ram.used_gb) ramParts.push(`Used ${ram.used_gb} GB`);
          if (ram.available_gb) ramParts.push(`Free ${ram.available_gb} GB`);
          if (ram.percent) ramParts.push(`${ram.percent}%`);
          if (ramParts.length) rows.push(`<div><strong>RAM:</strong> ${ramParts.join(' • ')}</div>`);
          if (gpus.length) {
            const g = gpus.map(g => `${g.name} (${g.memory_used_mb || 0}/${g.memory_total_mb || 0} MB)`).join(', ');
            rows.push(`<div><strong>GPU:</strong> ${g}</div>`);
          } else {
            rows.push('<div><strong>GPU:</strong> Not detected</div>');
          }
          el.innerHTML = rows.join('');
        } catch (e) {
          el.textContent = 'Failed to fetch system info';
        }
      }
      document.getElementById('refresh-sys').addEventListener('click', fetchSys);
      fetchSys();
    })();
  </script>
  <script src="auth.js"></script>
</body>
</html>
